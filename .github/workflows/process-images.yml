name: Process New Images

on:
  push:
    paths:
      - "images/new/**"

jobs:
  process-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Process images and generate JSON
        run: |
          mkdir -p images/cars
          mkdir -p data

          declare -A normalMap
          declare -A featuredMap

          shopt -s nullglob
          for img in images/new/*; do
            file=$(basename "$img")

            # Skip if not an image
            if [[ ! "$file" =~ \.(jpg|jpeg|png|webp|JPG|JPEG|PNG|WEBP)$ ]]; then
              echo "Skipping non-image: $file"
              continue
            fi

            echo "Processing: $file"

            # Extract serial such as CW-001 or CW-100
            serial=$(echo "$file" | grep -oE 'CW-[0-9]+')
            if [[ -z "$serial" ]]; then
              echo "❌ No serial found in $file — skipping"
              continue
            fi

            # Check whether this is a featured image
            if [[ "$file" == *"-featured"* ]]; then
              type="featured"
            else
              type="normal"
            fi

            # Resize and optimize
            convert "$img" -resize 2000x2000\> -strip -quality 85 "images/cars/$file"

            # FULL RAW URL
            url="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/images/cars/$file"

            # Assign to maps
            if [[ "$type" == "featured" ]]; then
              featuredMap[$serial]="\"$url\""
            else
              if [[ -z "${normalMap[$serial]}" ]]; then
                normalMap[$serial]="\"$url\""
              else
                normalMap[$serial]="${normalMap[$serial]}, \"$url\""
              fi
            fi
          done

          echo "Generating JSON…"

          echo "[" > data/images.json
          first=true

          all_serials=$(printf "%s\n" "${!normalMap[@]}" "${!featuredMap[@]}" | sort -u)

          for serial in $all_serials; do
            normal="${normalMap[$serial]}"
            featured="${featuredMap[$serial]}"

            if [[ "$first" == true ]]; then
              first=false
            else
              echo "," >> data/images.json
            fi

            echo "  {" >> data/images.json
            echo "    \"serial\": \"$serial\"," >> data/images.json
            echo "    \"images\": [${normal:-}]," >> data/images.json
            echo "    \"featuredImage\": ${featured:-null}" >> data/images.json
            echo -n "  }" >> data/images.json
          done

          echo "" >> data/images.json
          echo "]" >> data/images.json

          echo "Cleaning new images…"
          rm -f images/new/*

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images/cars data/images.json
          git commit -m "Processed images" || echo "No changes"
          git push
