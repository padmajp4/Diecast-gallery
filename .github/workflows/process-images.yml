name: Process New Images

on:
  push:
    branches:
      - main   # runs on every push to main
  workflow_dispatch:     # allow manual trigger from Actions tab

jobs:
  process-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install imagemagick -y

      - name: Process images + Build JSON
        run: |
          mkdir -p images/cars
          mkdir -p data
          
          # -----------------------------
          # BUILD ASSOCIATIVE ARRAYS
          # -----------------------------
          declare -A normalMap
          declare -A featuredMap

          echo "Scanning images/new..."
          
          shopt -s nullglob
          for img in images/new/*; do
            file=$(basename "$img")

            # ----------------------------------------
            # CHECK IF IMAGE IS FEATURED OR NORMAL
            # ----------------------------------------
            if [[ "$file" =~ -featured\.jpg$ ]]; then
              serial=$(echo "$file" | sed -E 's/.*-(CW-[0-9]+)-featured\.jpg/\1/')
              type="featured"
            else
              serial=$(echo "$file" | sed -E 's/.*-(CW-[0-9]+)\.jpg/\1/')
              type="normal"
            fi

            [[ -z "$serial" ]] && continue

            # Resize and save
            convert "$img" -resize 2000x2000\> -strip -quality 85 "images/cars/$file"

            url="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/images/cars/$file"

            if [[ "$type" == "featured" ]]; then
              featuredMap[$serial]="\"$url\""
            else
              if [[ -z "${normalMap[$serial]}" ]]; then
                normalMap[$serial]="\"$url\""
              else
                normalMap[$serial]="${normalMap[$serial]}, \"$url\""
              fi
            fi
          done

          echo "Processing complete. Building JSON..."

          # -------------------------
          # BUILD images.json
          # -------------------------
          echo "[" > data/images.json
          first=true

          for serial in "${!normalMap[@]}"; do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> data/images.json
            fi

            featuredValue=${featuredMap[$serial]:-"null"}

            echo "  {" >> data/images.json
            echo "    \"serial\": \"$serial\"," >> data/images.json
            echo "    \"images\": [${normalMap[$serial]}]," >> data/images.json
            echo "    \"featuredImage\": ${featuredValue}" >> data/images.json
            echo "  }" >> data/images.json
          done

          echo "]" >> data/images.json

          # Clean new folder
          rm -f images/new/*

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add images/cars data/images.json
          git commit -m "Processed new images" || echo "No changes to commit"
          git push
