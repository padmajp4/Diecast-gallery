name: Process New Images

on:
  push:
    paths:
      - "images/new/**"

jobs:
  process-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install ImageMagick + WebP + HEIC
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            imagemagick \
            webp \
            libheif1 \
            libheif-examples \
            icc-profiles

      - name: Process images and generate JSON
        shell: bash
        run: |
          mkdir -p images/cars
          mkdir -p data

          declare -A normalMap
          declare -A featuredMap

          shopt -s nullglob
          for img in images/new/*; do
            file=$(basename "$img")

            # Skip non-images
            if [[ ! "$file" =~ \.(jpg|jpeg|png|webp|heic|JPG|JPEG|PNG|WEBP|HEIC)$ ]]; then
              echo "Skipping non-image: $file"
              continue
            fi

            echo "Processing: $file"

            # Extract CW-### serial
            serial=$(echo "$file" | grep -oE 'CW-[0-9]+')
            if [[ -z "$serial" ]]; then
              echo "❌ No serial found in $file — skipping"
              continue
            fi

            ###########################################
            # FEATURED IMAGE — PNG ONLY (NO CONVERT)
            ###########################################
            if [[ "$file" == *"-featured"* ]]; then
              if [[ "$file" =~ \.png$|\.PNG$ ]]; then
                echo "Copying FEATURED PNG image: $file"
                cp "$img" "images/cars/$file"
                outFile="$file"
                type="featured"
              else
                echo "❌ FEATURED image must be PNG. Skipping: $file"
                continue
              fi

            ###########################################
            # NORMAL IMAGE LOGIC (HEIC SUPPORTED)
            ###########################################
            else
              type="normal"

              # Already WebP → keep as-is
              if [[ "$file" =~ \.webp$|\.WEBP$ ]]; then
                echo "Copying WEBP without convert: $file"
                cp "$img" "images/cars/$file"
                outFile="$file"

              # JPG / PNG / HEIC → convert to WebP (COLOR + BRIGHTNESS SAFE)
              else
                outFile="${file%.*}.webp"
                echo "Converting to WebP (color & brightness safe): $file → $outFile"

                convert "$img" \
                  -colorspace RGB \
                  -profile /usr/share/color/icc/sRGB.icc \
                  -gamma 1.05 \
                  -resize 2000x2000\> \
                  -strip \
                  -quality 85 \
                  "images/cars/$outFile"
              fi
            fi

            # RAW GitHub URL
            url="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/images/cars/$outFile"

            # Store
            if [[ "$type" == "featured" ]]; then
              featuredMap[$serial]="\"$url\""
            else
              if [[ -z "${normalMap[$serial]}" ]]; then
                normalMap[$serial]="\"$url\""
              else
                normalMap[$serial]="${normalMap[$serial]}, \"$url\""
              fi
            fi
          done

          ########################
          # WRITE JSON
          ########################
          echo "[" > data/images.json
          first=true

          all_serials=$(printf "%s\n" "${!normalMap[@]}" "${!featuredMap[@]}" | sort -u)

          for serial in $all_serials; do
            normal="${normalMap[$serial]}"
            featured="${featuredMap[$serial]}"

            if [[ "$first" == true ]]; then
              first=false
            else
              echo "," >> data/images.json
            fi

            echo "  {" >> data/images.json
            echo "    \"serial\": \"$serial\"," >> data/images.json
            echo "    \"images\": [${normal:-}]," >> data/images.json
            echo "    \"featuredImage\": ${featured:-null}" >> data/images.json
            echo -n "  }" >> data/images.json
          done

          echo "" >> data/images.json
          echo "]" >> data/images.json

          echo "Cleaning new images…"
          rm -f images/new/*

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images/cars data/images.json
          git commit -m "Processed images" || echo "No changes"
          git push
